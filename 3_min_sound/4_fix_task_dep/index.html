<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Fix Superfluous Task Dependency - Build your own Programmatic Incremental Build System</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../.././diff2html.min.css">
        <link rel="stylesheet" href="../.././mdbook-admonish.css">

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../0_intro/index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../0_intro/1_setup/index.html"><strong aria-hidden="true">1.1.</strong> Setup</a></li></ol></li><li class="chapter-item expanded "><a href="../../1_programmability/index.html"><strong aria-hidden="true">2.</strong> Programmability</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../1_programmability/1_api/index.html"><strong aria-hidden="true">2.1.</strong> Programmable Build System API</a></li><li class="chapter-item expanded "><a href="../../1_programmability/2_non_incremental/index.html"><strong aria-hidden="true">2.2.</strong> Non-Incremental Context</a></li></ol></li><li class="chapter-item expanded "><a href="../../2_incrementality/index.html"><strong aria-hidden="true">3.</strong> Incrementality</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../2_incrementality/1_require_file/index.html"><strong aria-hidden="true">3.1.</strong> Requiring Files</a></li><li class="chapter-item expanded "><a href="../../2_incrementality/2_stamp/index.html"><strong aria-hidden="true">3.2.</strong> Stamps</a></li><li class="chapter-item expanded "><a href="../../2_incrementality/3_dependency/index.html"><strong aria-hidden="true">3.3.</strong> Dynamic Dependencies</a></li><li class="chapter-item expanded "><a href="../../2_incrementality/4_store/index.html"><strong aria-hidden="true">3.4.</strong> Dependency Graph Store</a></li><li class="chapter-item expanded "><a href="../../2_incrementality/5_context/index.html"><strong aria-hidden="true">3.5.</strong> Incremental Top-Down Context</a></li><li class="chapter-item expanded "><a href="../../2_incrementality/6_example/index.html"><strong aria-hidden="true">3.6.</strong> Incrementality Example</a></li></ol></li><li class="chapter-item expanded "><a href="../../3_min_sound/index.html"><strong aria-hidden="true">4.</strong> Testing Incrementality & Soundness</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../3_min_sound/1_session/index.html"><strong aria-hidden="true">4.1.</strong> Minimality with Sessions</a></li><li class="chapter-item expanded "><a href="../../3_min_sound/2_tracker/index.html"><strong aria-hidden="true">4.2.</strong> Tracking Build Events</a></li><li class="chapter-item expanded "><a href="../../3_min_sound/3_test/index.html"><strong aria-hidden="true">4.3.</strong> Integration Testing</a></li><li class="chapter-item expanded "><a href="../../3_min_sound/4_fix_task_dep/index.html" class="active"><strong aria-hidden="true">4.4.</strong> Fix Superfluous Task Dependency</a></li><li class="chapter-item expanded "><a href="../../3_min_sound/5_overlap/index.html"><strong aria-hidden="true">4.5.</strong> Prevent Overlapping File Writes</a></li><li class="chapter-item expanded "><a href="../../3_min_sound/6_hidden_dep/index.html"><strong aria-hidden="true">4.6.</strong> Prevent Hidden Dependencies</a></li><li class="chapter-item expanded "><a href="../../3_min_sound/7_cycle/index.html"><strong aria-hidden="true">4.7.</strong> Prevent Cycles</a></li></ol></li><li class="chapter-item expanded "><a href="../../4_next/index.html"><strong aria-hidden="true">5.</strong> What's Next?</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
<!-- CHANGE: removed all but light and ayu theme, and renamed ayu to dark -->                          
<!--                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>-->
<!--                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>-->
<!--                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>-->
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Dark</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Build your own Programmatic Incremental Build System</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/Gohla/pie/" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/Gohla/pie/edit/master/tutorial/src/3_min_sound/4_fix_task_dep/index.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="fix-superfluous-task-dependency"><a class="header" href="#fix-superfluous-task-dependency">Fix Superfluous Task Dependency</a></h1>
<p>There is actually a massive bug in our implementation.
If you noticed the issue while following this tutorial, you’re pretty observant!
If you didn’t catch it, don’t worry. 
I actually didn’t catch it either up until this point!</p>
<p>I decided to keep the bug in to show how hard it is to test incrementality and soundness.</p>
<p>Let’s start by adding another testing task which we need to uncover the bug, and then write a test that manifests the bug.</p>
<h2 id="add-toupper-task"><a class="header" href="#add-toupper-task">Add <code>ToUpper</code> task</a></h2>
<p>Modify <code>pie/src/tests/common/mod.rs</code> to add another task:</p>
<div class="diff2html" id="diff2html_0"></div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    let diff = String.raw`--- pie/tests/common/mod.rs
+++ pie/tests/common/mod.rs
@@ -64,6 +64,7 @@
   Return(&'static str),
   ReadFile(PathBuf, FileStamper),
   ToLower(Box<TestTask>),
+  ToUpper(Box<TestTask>),
 }
 impl Task for TestTask {
   type Output = Result<TestOutput, ErrorKind>;
@@ -81,6 +82,10 @@
         let string = context.require_task(string_provider_task)?.into_string();
         Ok(string.to_lowercase().into())
       }
+      TestTask::ToUpper(string_provider_task) => {
+        let string = context.require_task(string_provider_task)?.into_string();
+        Ok(string.to_uppercase().into())
+      }
     }
   }
 }
`;
    let target = document.getElementById('diff2html_0');
    let configuration = {
      drawFileList: false,
      fileListToggle: false,
      fileContentToggle: false,

      outputFormat: 'line-by-line',
      matching: 'lines',
    };
    let diff2htmlUi = new Diff2HtmlUI(target, diff, configuration, hljs);
    diff2htmlUi.draw();
  });
</script>
<p>The <code>ToUpper</code> task does (as expected) the opposite of the <code>ToLower</code> task: it requires the string providing task and returns the string in uppercase.</p>
<h2 id="test-case-setup"><a class="header" href="#test-case-setup">Test case setup</a></h2>
<p>No we set up a test case uncover the bug.
Modify <code>pie/src/tests/top_down.rs</code> to add another test:</p>
<div class="diff2html" id="diff2html_1"></div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    let diff = String.raw`--- pie/tests/top_down.rs
+++ pie/tests/top_down.rs
@@ -206,3 +206,35 @@
   // - Task require ends should be later than their executes.
   assert!(require.end() > execute.end());
 }
+
+#[test]
+fn test_no_superfluous_task_dependencies() -> Result<(), io::Error> {
+  let mut pie = test_pie();
+  let temp_dir = create_temp_dir()?;
+
+  let file = temp_dir.path().join("in.txt");
+  write(&file, "Hello, World!")?;
+  let read = ReadFile(file.clone(), FileStamper::Modified);
+  let lower = ToLower(Box::new(read.clone()));
+  let upper = ToUpper(Box::new(lower.clone()));
+
+  // Require ${"`"}ToLower${"`"} and assert that ${"`"}ReadFile${"`"} and ${"`"}ToLower${"`"} are executed because they are new, but not ${"`"}ToUpper${"`"},
+  // because it not required by anything. ${"`"}ToLower${"`"} will return ${"`"}"hello, world!"${"`"}.
+  let output = pie.require_then_assert(&lower, |tracker| {
+    assert!(tracker.one_execute_of(&read));
+    assert!(tracker.one_execute_of(&lower));
+    assert!(!tracker.any_execute_of(&upper));
+  })?;
+  assert_eq!(output.as_str(), "hello, world!");
+
+  // Require ${"`"}ToUpper${"`"} and assert that it is executed because it is new, but not ${"`"}ReadFile${"`"} nor ${"`"}ToLower${"`"} because their
+  // dependencies are consistent.
+  let output = pie.require_then_assert(&upper, |tracker| {
+    assert!(!tracker.any_execute_of(&read));
+    assert!(!tracker.any_execute_of(&lower));
+    assert!(tracker.one_execute_of(&upper));
+  })?;
+  assert_eq!(output.as_str(), "HELLO, WORLD!");
+
+  Ok(())
+}
`;
    let target = document.getElementById('diff2html_1');
    let configuration = {
      drawFileList: false,
      fileListToggle: false,
      fileContentToggle: false,

      outputFormat: 'line-by-line',
      matching: 'lines',
    };
    let diff2htmlUi = new Diff2HtmlUI(target, diff, configuration, hljs);
    diff2htmlUi.draw();
  });
</script>
<p>This test is similar to the previous one, but we have added a <code>ToUpper</code> task which requires the <code>ToLower</code> task.
We first require <code>ToLower</code> and assert that only <code>ToLower</code> and <code>ReadFile</code> are executed.
<code>ToUpper</code> should not be executed because we have not required it, and neither <code>ToLower</code> nor <code>ReadFile</code> require it.</p>
<p>Then, we require <code>ToUpper</code> and assert that it is executed.
Neither <code>ToLower</code> nor <code>ReadFile</code> should be executed because their dependencies are still consistent.</p>
<p>Check that this test, so far, succeeds with <code>cargo test</code>.
You can inspect the build log with <code>cargo test --test top_down test_no_superfluous_task_dependencies</code> to see what is going on, but it should look pretty normal.
The important part of this setup is that <code>ToLower</code> returns <code>&quot;hello, world!&quot;</code>.</p>
<h2 id="manifest-the-bug"><a class="header" href="#manifest-the-bug">Manifest the bug</a></h2>
<p>Manifest the bug by modifying <code>pie/src/tests/top_down.rs</code>:</p>
<div class="diff2html" id="diff2html_2"></div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    let diff = String.raw`--- pie/tests/top_down.rs
+++ pie/tests/top_down.rs
@@ -236,5 +236,19 @@
   })?;
   assert_eq!(output.as_str(), "HELLO, WORLD!");
 
+  // Change ${"`"}file${"`"} such that the file dependency of ${"`"}ReadFile${"`"} becomes inconsistent. However, we change its contents
+  // only slightly by turning 'l' characters into capital 'L' characters. Therefore, ${"`"}ToLower${"`"} will still return
+  // ${"`"}"hello, world!"${"`"}.
+  write_until_modified(&file, "HeLLo, WorLd!")?;
+
+  // Require ${"`"}ToUpper${"`"} but assert that it is _not executed_ because ${"`"}ToUpper${"`"}'s task dependency to ${"`"}ToLower${"`"} is still
+  // consistent, because ${"`"}ToLower${"`"} still returns ${"`"}"hello, world!"${"`"} which is the same as last time.
+  let output = pie.require_then_assert(&upper, |tracker| {
+    assert!(tracker.one_execute_of(&read));
+    assert!(tracker.one_execute_of(&lower));
+    assert!(!tracker.any_execute_of(&upper));
+  })?;
+  assert_eq!(output.as_str(), "HELLO, WORLD!");
+
   Ok(())
 }
`;
    let target = document.getElementById('diff2html_2');
    let configuration = {
      drawFileList: false,
      fileListToggle: false,
      fileContentToggle: false,

      outputFormat: 'line-by-line',
      matching: 'lines',
    };
    let diff2htmlUi = new Diff2HtmlUI(target, diff, configuration, hljs);
    diff2htmlUi.draw();
  });
</script>
<p>We change <code>file</code> in a very specific way: we capitalize the <code>l</code> characters to <code>L</code> characters.
We do this to trigger early cutoff.
By changing <code>file</code> in this way, we expect <code>ReadFile</code> to execute and return <code>&quot;HeLLo, WorLd!&quot;</code>.
This in turn means that <code>ToLower</code>’s task dependency to <code>ReadFile</code> is inconsistent, because the output changed, so <code>ToLower</code> is executed.
However, <code>ToLower</code> changes those <code>L</code> characters back into <code>l</code> and returns <code>&quot;hello, world!&quot;</code>, which is the same as last time.
Therefore, <code>ToUpper</code>’s task dependency to <code>ToLower</code> is still consistent, and we can cut off the build early.
We assert this inside the <code>require_then_assert</code> block.</p>
<p>But, if you run the tests with <code>cargo test</code>, this test will fail!
How can that be?</p>
<div id="admonition-expected-test-failure" class="admonition admonish-failure">
<div class="admonition-title">
<p>Expected Test Failure</p>
<p><a class="admonition-anchor-link" href="#admonition-expected-test-failure"></a></p>
</div>
<div>
<p>Test <code>test_no_superfluous_task_dependencies</code> will fail as expected, which we will fix in this section!</p>
</div>
</div>
<p>Inspect the build log with <code>cargo test --test top_down test_no_superfluous_task_dependencies</code>.
The third (last) build log should look like this:</p>
<pre><code>→ ToUpper(ToLower(ReadFile(&quot;/tmp/.tmpT154JJ/in.txt&quot;, Modified)))
 ? ReadFile(&quot;/tmp/.tmpT154JJ/in.txt&quot;, Modified)
  → ReadFile(&quot;/tmp/.tmpT154JJ/in.txt&quot;, Modified)
   ✗ /tmp/.tmpT154JJ/in.txt (old: Modified(Some(SystemTime { tv_sec: 1698244700, tv_nsec: 343963528 })) ≠ new: Modified(Some(SystemTime { tv_sec: 1698244700, tv_nsec: 347963555 })))
   ▶ ReadFile(&quot;/tmp/.tmpT154JJ/in.txt&quot;, Modified)
    - /tmp/.tmpT154JJ/in.txt
   ◀ Ok(String(&quot;HeLLo, WorLd!&quot;))
  ← Ok(String(&quot;HeLLo, WorLd!&quot;))
 ✗ ReadFile(&quot;/tmp/.tmpT154JJ/in.txt&quot;, Modified) (old: Equals(Ok(String(&quot;Hello, World!&quot;))) ≠ new: Equals(Ok(String(&quot;HeLLo, WorLd!&quot;))))
 ▶ ToUpper(ToLower(ReadFile(&quot;/tmp/.tmpT154JJ/in.txt&quot;, Modified)))
  → ToLower(ReadFile(&quot;/tmp/.tmpT154JJ/in.txt&quot;, Modified))
   ? ReadFile(&quot;/tmp/.tmpT154JJ/in.txt&quot;, Modified)
    → ReadFile(&quot;/tmp/.tmpT154JJ/in.txt&quot;, Modified)
    ← Ok(String(&quot;HeLLo, WorLd!&quot;))
   ✗ ReadFile(&quot;/tmp/.tmpT154JJ/in.txt&quot;, Modified) (old: Equals(Ok(String(&quot;Hello, World!&quot;))) ≠ new: Equals(Ok(String(&quot;HeLLo, WorLd!&quot;))))
   ▶ ToLower(ReadFile(&quot;/tmp/.tmpT154JJ/in.txt&quot;, Modified))
    → ReadFile(&quot;/tmp/.tmpT154JJ/in.txt&quot;, Modified)
    ← Ok(String(&quot;HeLLo, WorLd!&quot;))
   ◀ Ok(String(&quot;hello, world!&quot;))
  ← Ok(String(&quot;hello, world!&quot;))
 ◀ Ok(String(&quot;HELLO, WORLD!&quot;))
← Ok(String(&quot;HELLO, WORLD!&quot;))
</code></pre>
<p>In this last build, <code>ToUpper</code> is required, and it will check its dependency to <code>ReadFile</code>.
But that shouldn’t happen, because <code>ToUpper</code> only has a dependency to <code>ToLower</code>!
There seems to be a bug where <code>ToLower</code>’s task dependency to <code>ReadFile</code>, somehow ended up with <code>ToUpper</code>.</p>
<p>We need to go back to our consistency checking code to find the cause.</p>
<h2 id="finding-the-cause"><a class="header" href="#finding-the-cause">Finding the cause</a></h2>
<p>In the previous chapter, we implemented dynamic dependencies including an <code>is_inconsistent</code> method to check if a dependency is consistent.
This is the code we used for task dependencies:</p>
<pre><code class="language-rust ">  pub fn is_inconsistent&lt;C: Context&lt;T&gt;&gt;(&amp;self, context: &amp;mut C) -&gt; Option&lt;OutputStamp&lt;T::Output&gt;&gt; {
    let output = context.require_task(&amp;self.task);
    let new_stamp = self.stamper.stamp(output);
    if new_stamp == self.stamp {
      None
    } else {
      Some(new_stamp)
    }
  }</code></pre>
<p>To check if a task dependency is consistent, we call <code>require</code> on the context (which calls <code>require_task_with_stamper</code> with a default stamper).
Later on we implemented this <code>require_task_with_stamper</code> method for <code>TopDownContext</code>:</p>
<pre><code class="language-rust ">    self.session.tracker.require_task_start(task, &amp;stamper);
    let node = self.session.store.get_or_create_task_node(task);

    // Get required task output by executing it if needed, or by getting the output from the store if not needed.
    let already_consistent = self.session.consistent.contains(&amp;node);
    let should_execute = !already_consistent &amp;&amp; self.should_execute_task(&amp;node);
    let output = if should_execute {
      self.session.tracker.execute_start(task);
      self.session.store.reset_task(&amp;node);
      let previous_executing_task = self.session.current_executing_task.replace(node);
      let output = task.execute(self);
      self.session.current_executing_task = previous_executing_task;
      self.session.store.set_task_output(&amp;node, output.clone());
      self.session.tracker.execute_end(task, &amp;output);
      output
    } else {
      // Correctness: when `should_execute_task` returns `true`, the above block is executed. Otherwise this block is
      // executed and `should_execute_task` ensures that the task has an output.
      self.session.store.get_task_output(&amp;node).clone()
    };

    let dependency = TaskDependency::new(task.clone(), stamper, output.clone());
    self.session.tracker.require_task_end(&amp;dependency, &amp;output, should_execute);

    // Create task require dependency if a task is currently executing (i.e., we are not requiring the initial task).
    if let Some(current_executing_task_node) = &amp;self.session.current_executing_task {
      if self.session.store.add_task_require_dependency(current_executing_task_node, &amp;node, dependency).is_err() {
        let current_executing_task = self.session.store.get_task(current_executing_task_node);
        panic!(&quot;Cyclic task dependency; current executing task '{:?}' is requiring task '{:?}' which was already required&quot;, current_executing_task, task);
      }
    }

    self.session.consistent.insert(node);
    output
  }
}</code></pre>
<p>In the <code>if let Some(current_executing_task_node)</code> block we are adding a task dependency from the current executing task (if any), to the task being required.
This is the cause of the bug.
Even if we are only <em>consistency checking</em> a task to see if it should be executed, we could end up adding a task dependency to the current executing task, which is not correct.
We only manifested the bug in the last test due to having a chain of 2 task dependencies, and by carefully controlling what is being executed and what is being checked.</p>
<p>Recall the second build in the <code>test_no_superfluous_task_dependencies</code> test.
The build log for that build looks like:</p>
<pre><code>→ ToUpper(ToLower(ReadFile(&quot;/tmp/.tmpT154JJ/in.txt&quot;, Modified)))
 ▶ ToUpper(ToLower(ReadFile(&quot;/tmp/.tmpT154JJ/in.txt&quot;, Modified)))
  → ToLower(ReadFile(&quot;/tmp/.tmpT154JJ/in.txt&quot;, Modified))
   ? ReadFile(&quot;/tmp/.tmpT154JJ/in.txt&quot;, Modified)
    → ReadFile(&quot;/tmp/.tmpT154JJ/in.txt&quot;, Modified)
     ✓ /tmp/.tmpT154JJ/in.txt
    ← Ok(String(&quot;Hello, World!&quot;))
   ✓ ReadFile(&quot;/tmp/.tmpT154JJ/in.txt&quot;, Modified)
  ← Ok(String(&quot;hello, world!&quot;))
 ◀ Ok(String(&quot;HELLO, WORLD!&quot;))
← Ok(String(&quot;HELLO, WORLD!&quot;))
</code></pre>
<p>In this build we are executing <code>ToUpper</code>, then require <code>ToLower</code>, then <em>consistency check</em> <code>ReadFile</code>, which in turn <em>requires</em> <code>ReadFile</code>.
At the end of that require, an incorrect dependency from <code>ToUpper</code> to <code>ReadFile</code> is made (although not really visible in the log).
This incorrect dependency then later breaks incrementality.</p>
<p>To fix this bug, we need to make sure that we only add task dependencies when an executing task directly requires another task, not when consistency checking!</p>
<h2 id="fixing-the-bug"><a class="header" href="#fixing-the-bug">Fixing the bug</a></h2>
<p>To fix the bug, we will separate the process of <em>making a task consistent</em>, which does not add task dependencies, from <em>requiring a task</em>, which can add task dependencies.
We will split this part into a <code>make_task_consistent</code> method.
Modify the top-down context from <code>pie/src/context/top_down.rs</code>:</p>
<div class="diff2html" id="diff2html_3"></div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    let diff = String.raw`--- pie/src/context/top_down.rs
+++ pie/src/context/top_down.rs
@@ -38,9 +38,28 @@
 
   fn require_task_with_stamper(&mut self, task: &T, stamper: OutputStamper) -> T::Output {
     self.session.tracker.require_task_start(task, &stamper);
+
     let node = self.session.store.get_or_create_task_node(task);
+    let (output, was_executed) = self.make_task_consistent(task, node);
+
+    let dependency = TaskDependency::new(task.clone(), stamper, output.clone());
+    self.session.tracker.require_task_end(&dependency, &output, was_executed);
+
+    // Create task require dependency if a task is currently executing (i.e., we are not requiring the initial task).
+    if let Some(current_executing_task_node) = &self.session.current_executing_task {
+      if self.session.store.add_task_require_dependency(current_executing_task_node, &node, dependency).is_err() {
+        let current_executing_task = self.session.store.get_task(current_executing_task_node);
+        panic!("Cyclic task dependency; current executing task '{:?}' is requiring task '{:?}' which was already required", current_executing_task, task);
+      }
+    }
 
-    // Get required task output by executing it if needed, or by getting the output from the store if not needed.
+    output
+  }
+}
+
+impl<'p, 's, T: Task, A: Tracker<T>> TopDownContext<'p, 's, T, T::Output, A> {
+  // Get required task output by executing it if needed, or by getting the output from the store if not needed.
+  fn make_task_consistent(&mut self, task: &T, node: TaskNode) -> (T::Output, bool) {
     let already_consistent = self.session.consistent.contains(&node);
     let should_execute = !already_consistent && self.should_execute_task(&node);
     let output = if should_execute {
@@ -57,24 +76,11 @@
       // executed and ${"`"}should_execute_task${"`"} ensures that the task has an output.
       self.session.store.get_task_output(&node).clone()
     };
-
-    let dependency = TaskDependency::new(task.clone(), stamper, output.clone());
-    self.session.tracker.require_task_end(&dependency, &output, should_execute);
-
-    // Create task require dependency if a task is currently executing (i.e., we are not requiring the initial task).
-    if let Some(current_executing_task_node) = &self.session.current_executing_task {
-      if self.session.store.add_task_require_dependency(current_executing_task_node, &node, dependency).is_err() {
-        let current_executing_task = self.session.store.get_task(current_executing_task_node);
-        panic!("Cyclic task dependency; current executing task '{:?}' is requiring task '{:?}' which was already required", current_executing_task, task);
-      }
-    }
 
     self.session.consistent.insert(node);
-    output
+    (output, should_execute)
   }
-}
 
-impl<'p, 's, T: Task, A: Tracker<T>> TopDownContext<'p, 's, T, T::Output, A> {
   /// Checks whether given task should be executed, returning ${"`"}true${"`"} if it should be executed. A task should be executed
   /// if any of its dependencies are inconsistent, or when it has no output.
   fn should_execute_task(&mut self, node: &TaskNode) -> bool {
`;
    let target = document.getElementById('diff2html_3');
    let configuration = {
      drawFileList: false,
      fileListToggle: false,
      fileContentToggle: false,

      outputFormat: 'side-by-side',
      matching: 'lines',
    };
    let diff2htmlUi = new Diff2HtmlUI(target, diff, configuration, hljs);
    diff2htmlUi.draw();
  });
</script>
<p>We extracted the core of the <code>require_task_with_stamper</code> method into a <code>make_task_consistent</code> method, and call <code>make_task_consistent</code> in <code>require_task_with_stamper</code>.
This is a refactoring, so the <code>require_task_with_stamper</code> method will behave the same as before.</p>
<p>To reiterate, <code>make_task_consistent</code> makes given task is consistent by checking the task, executing it if inconsistent, and returning its output.
If it is already consistent, we return the cached output.
In both cases we also use and update <code>self.session.consistent</code>: the set of already consistent tasks this session. </p>
<p>Now we need to change the <code>is_inconsistent</code> methods on dependencies to use <code>make_task_consistent</code> instead.
However, the <code>is_inconsistent</code> method is generic over <code>Context</code>, which doesn’t expose the <code>make_task_consistent</code> method.
We also do not want to expose <code>make_task_consistent</code> to users of the library, as it would allow tasks authors to make tasks consistent without adding dependencies, which could break incrementality.
Therefore, we will define a <code>MakeConsistent</code> trait in the dependency module, and have <code>TopDownContext</code> implement that.</p>
<p>Modify <code>pie/src/dependency.rs</code>:</p>
<div class="diff2html" id="diff2html_4"></div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    let diff = String.raw`--- pie/src/dependency.rs
+++ pie/src/dependency.rs
@@ -3,7 +3,7 @@
 use std::io;
 use std::path::PathBuf;
 
-use crate::{Context, Task};
+use crate::Task;
 use crate::fs::open_if_file;
 use crate::stamp::{FileStamp, FileStamper, OutputStamp, OutputStamper};
 
@@ -89,8 +89,8 @@
   /// Checks whether this task dependency is inconsistent, returning:
   /// - ${"`"}Some(stamp)${"`"} if this dependency is inconsistent (with ${"`"}stamp${"`"} being the new stamp of the dependency),
   /// - ${"`"}None${"`"} if this dependency is consistent.
-  pub fn is_inconsistent<C: Context<T>>(&self, context: &mut C) -> Option<OutputStamp<T::Output>> {
-    let output = context.require_task(&self.task);
+  pub fn is_inconsistent<C: MakeConsistent<T>>(&self, context: &mut C) -> Option<OutputStamp<T::Output>> {
+    let output = context.make_task_consistent(&self.task);
     let new_stamp = self.stamper.stamp(output);
     if new_stamp == self.stamp {
       None
@@ -100,6 +100,11 @@
   }
 }
 
+/// Make a task consistent without adding dependencies.
+pub trait MakeConsistent<T: Task> {
+  fn make_task_consistent(&mut self, task: &T) -> T::Output;
+}
+
 
 #[derive(Clone, Eq, PartialEq, Debug)]
 pub enum Dependency<T, O> {
@@ -118,7 +123,7 @@
   /// - ${"`"}Ok(Some(stamp))${"`"} if the dependency is inconsistent (with ${"`"}stamp${"`"} being the new stamp of the dependency),
   /// - ${"`"}Ok(None)${"`"} if the dependency is consistent,
   /// - ${"`"}Err(e)${"`"} if there was an error checking the dependency for consistency.
-  pub fn is_inconsistent<C: Context<T>>(&self, context: &mut C) -> Result<Option<Inconsistency<T::Output>>, io::Error> {
+  pub fn is_inconsistent<C: MakeConsistent<T>>(&self, context: &mut C) -> Result<Option<Inconsistency<T::Output>>, io::Error> {
     let option = match self {
       Dependency::RequireFile(d) => d.is_inconsistent()?
         .map(|s| Inconsistency::File(s)),
@@ -137,6 +142,7 @@
 
   use dev_shared::{create_temp_file, write_until_modified};
 
+  use crate::Context;
   use crate::context::non_incremental::NonIncrementalContext;
 
   use super::*;
`;
    let target = document.getElementById('diff2html_4');
    let configuration = {
      drawFileList: false,
      fileListToggle: false,
      fileContentToggle: false,

      outputFormat: 'side-by-side',
      matching: 'lines',
    };
    let diff2htmlUi = new Diff2HtmlUI(target, diff, configuration, hljs);
    diff2htmlUi.draw();
  });
</script>
<p>We add the <code>MakeConsistent</code> trait and use it in <code>is_inconsistent</code>. 
Now we go back to <code>TopDownContext</code> and implement that trait.</p>
<p>Modify <code>pie/src/context/top_down.rs</code>:</p>
<div class="diff2html" id="diff2html_5"></div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    let diff = String.raw`--- pie/src/context/top_down.rs
+++ pie/src/context/top_down.rs
@@ -3,7 +3,7 @@
 use std::path::Path;
 
 use crate::{Context, fs, Session, Task};
-use crate::dependency::{FileDependency, TaskDependency};
+use crate::dependency::{FileDependency, MakeConsistent, TaskDependency};
 use crate::stamp::{FileStamper, OutputStamper};
 use crate::store::TaskNode;
 use crate::tracker::Tracker;
@@ -57,6 +57,14 @@
   }
 }
 
+impl<'p, 's, T: Task, A: Tracker<T>> MakeConsistent<T> for TopDownContext<'p, 's, T, T::Output, A> {
+  fn make_task_consistent(&mut self, task: &T) -> T::Output {
+    let node = self.session.store.get_or_create_task_node(task);
+    let (output, _) = self.make_task_consistent(task, node);
+    output
+  }
+}
+
 impl<'p, 's, T: Task, A: Tracker<T>> TopDownContext<'p, 's, T, T::Output, A> {
   // Get required task output by executing it if needed, or by getting the output from the store if not needed.
   fn make_task_consistent(&mut self, task: &T, node: TaskNode) -> (T::Output, bool) {
`;
    let target = document.getElementById('diff2html_5');
    let configuration = {
      drawFileList: false,
      fileListToggle: false,
      fileContentToggle: false,

      outputFormat: 'side-by-side',
      matching: 'lines',
    };
    let diff2htmlUi = new Diff2HtmlUI(target, diff, configuration, hljs);
    diff2htmlUi.draw();
  });
</script>
<p>We implement the <code>MakeConsistent</code> trait on <code>TopDownContext</code>, forwarding it to the <code>make_task_consistent</code> method.</p>
<p>We also need to implement this trait for the <code>NonIncrementalContext</code>.
Modify <code>pie/src/context/non_incremental.rs</code>:</p>
<div class="diff2html" id="diff2html_6"></div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    let diff = String.raw`--- pie/src/context/non_incremental.rs
+++ pie/src/context/non_incremental.rs
@@ -3,6 +3,7 @@
 use std::path::Path;
 
 use crate::{Context, Task};
+use crate::dependency::MakeConsistent;
 use crate::fs::open_if_file;
 use crate::stamp::{FileStamper, OutputStamper};
 
@@ -18,6 +19,12 @@
   }
 }
 
+impl<'p, 's, T: Task> MakeConsistent<T> for NonIncrementalContext {
+  fn make_task_consistent(&mut self, task: &T) -> T::Output {
+    task.execute(self)
+  }
+}
+
 #[cfg(test)]
 mod test {
   use super::*;
`;
    let target = document.getElementById('diff2html_6');
    let configuration = {
      drawFileList: false,
      fileListToggle: false,
      fileContentToggle: false,

      outputFormat: 'side-by-side',
      matching: 'lines',
    };
    let diff2htmlUi = new Diff2HtmlUI(target, diff, configuration, hljs);
    diff2htmlUi.draw();
  });
</script>
<p>If you run <code>cargo test</code> now, <code>test_no_superfluous_task_dependencies</code> should succeed, indicating that we fixed the bug!
However, <code>test_require_task</code> now fails 😅.</p>
<div id="admonition-fixed-tests" class="admonition admonish-success">
<div class="admonition-title">
<p>Fixed Tests</p>
<p><a class="admonition-anchor-link" href="#admonition-fixed-tests"></a></p>
</div>
<div>
<p>Test <code>test_no_superfluous_task_dependencies</code> should now succeed.</p>
</div>
</div>
<div id="admonition-expected-test-failure-1" class="admonition admonish-failure">
<div class="admonition-title">
<p>Expected Test Failure</p>
<p><a class="admonition-anchor-link" href="#admonition-expected-test-failure-1"></a></p>
</div>
<div>
<p>Test <code>test_require_task</code> will fail as expected, which we will now fix!</p>
</div>
</div>
<p>An <code>assert!(execute.start() &gt; require.start())</code> in this test now fails, which is a sanity check asserting that “executes starts” should be later than “require starts”
This is because our changes have correctly removed several superfluous task requires, which influences these assertions.</p>
<p>Inspect the build log for this test with <code>cargo test --test top_down test_require_task</code>.
The second build now looks like:</p>
<pre><code>→ ToLower(ReadFile(&quot;/tmp/.tmpJDwzGs/in.txt&quot;, Modified))
 ? ReadFile(&quot;/tmp/.tmpJDwzGs/in.txt&quot;, Modified)
  ✓ /tmp/.tmpJDwzGs/in.txt
 ✓ ReadFile(&quot;/tmp/.tmpJDwzGs/in.txt&quot;, Modified)
← Ok(String(&quot;hello world!&quot;))
</code></pre>
<p>In this second build, <code>ReadFile</code> is now no longer required, and instead is only checked.
This is correct, and does not make any assertions fail.</p>
<p>The third build now looks like:</p>
<pre><code>→ ToLower(ReadFile(&quot;/tmp/.tmpJDwzGs/in.txt&quot;, Modified))
 ? ReadFile(&quot;/tmp/.tmpJDwzGs/in.txt&quot;, Modified)
  ✗ /tmp/.tmpJDwzGs/in.txt (old: Modified(Some(SystemTime { tv_sec: 1698244702, tv_nsec: 227976274 })) ≠ new: Modified(Some(SystemTime { tv_sec: 1698244702, tv_nsec: 231976301 })))
  ▶ ReadFile(&quot;/tmp/.tmpJDwzGs/in.txt&quot;, Modified)
   - /tmp/.tmpJDwzGs/in.txt
  ◀ Ok(String(&quot;!DLROW OLLEH&quot;))
 ✗ ReadFile(&quot;/tmp/.tmpJDwzGs/in.txt&quot;, Modified) (old: Equals(Ok(String(&quot;HELLO WORLD!&quot;))) ≠ new: Equals(Ok(String(&quot;!DLROW OLLEH&quot;))))
 ▶ ToLower(ReadFile(&quot;/tmp/.tmpJDwzGs/in.txt&quot;, Modified))
  → ReadFile(&quot;/tmp/.tmpJDwzGs/in.txt&quot;, Modified)
  ← Ok(String(&quot;!DLROW OLLEH&quot;))
 ◀ Ok(String(&quot;!dlrow olleh&quot;))
← Ok(String(&quot;!dlrow olleh&quot;))
</code></pre>
<p>In this third build, <code>ReadFile</code> is also no longer required at the start, but later on in the build it <em>is</em> required when <code>ToLower</code> is executed.
This is correct, as it is only <em>checked</em> (using <code>make_task_consistent</code>) at the start, but <em>required</em> later while <code>ToLower</code> is executing.</p>
<p>The problem is that this assertion just does not hold anymore, as a task can be executed without first being required.
What does hold, is that a task is only executed after being checked <em>or</em> required.
However, we don’t track checking in the event tracker, so we will just remove this assertion to keep the tutorial going.
We will also update the expected build logs in the comments to reflect our changes.</p>
<p>Fix the tests by modifying <code>pie/src/tests/top_down.rs</code>:</p>
<div class="diff2html" id="diff2html_7"></div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    let diff = String.raw`--- pie/tests/top_down.rs
+++ pie/tests/top_down.rs
@@ -131,9 +131,7 @@
   // 2) Require ${"`"}ToLower${"`"} again and assert that no tasks are executed because all dependencies are consistent:
   // → ToLower
   //   ? ReadFile
-  //     → ReadFile
-  //       ✓ ${"`"}file${"`"}
-  //     ← Ok(String("HELLO WORLD!"))
+  //     ✓ ${"`"}file${"`"}
   //   ✓ ReadFile
   // ← Ok(String("hello world!"))
   // 🏁
@@ -146,12 +144,10 @@
   // 3) Require ${"`"}ToLower${"`"} and assert that both tasks are re-executed in reverse dependency order:
   // → ToLower
   //   ? ReadFile
-  //     → ReadFile
-  //       ✗ ${"`"}file${"`"} [inconsistent: modified file stamp change]
-  //       ▶ ReadFile [reason: ${"`"}file${"`"} is inconsistent due to modified file stamp change]
-  //         - ${"`"}file${"`"}
-  //       ◀ Ok(String("!DLROW OLLEH")) [note: returns a different output!]
-  //     ← Ok(String("!DLROW OLLEH"))
+  //     ✗ ${"`"}file${"`"} [inconsistent: modified file stamp change]
+  //     ▶ ReadFile [reason: ${"`"}file${"`"} is inconsistent due to modified file stamp change]
+  //       - ${"`"}file${"`"}
+  //     ◀ Ok(String("!DLROW OLLEH")) [note: returns a different output!]
   //   ✗ ReadFile [inconsistent: equals output stamp change]
   //   ▶ ToLower [reason: ReadFile is inconsistent due to equals output stamp change]
   //     → ReadFile
@@ -200,10 +196,7 @@
   // Require and execute ends come after require and execute starts.
   assert!(require.end() > require.start());
   assert!(execute.end() > execute.start());
-  // A task is only executed if it is required.
-  // - Task execute starts should be later than their requires.
-  assert!(execute.start() > require.start());
-  // - Task require ends should be later than their executes.
+  // Task require ends should be later than their executes.
   assert!(require.end() > execute.end());
 }
 
`;
    let target = document.getElementById('diff2html_7');
    let configuration = {
      drawFileList: false,
      fileListToggle: false,
      fileContentToggle: false,

      outputFormat: 'side-by-side',
      matching: 'lines',
    };
    let diff2htmlUi = new Diff2HtmlUI(target, diff, configuration, hljs);
    diff2htmlUi.draw();
  });
</script>
<p>Confirm this fixes the tests with <code>cargo test</code>.
All tests are green! 🎉🎉🎉</p>
<div id="admonition-fixed-tests-1" class="admonition admonish-success">
<div class="admonition-title">
<p>Fixed Tests</p>
<p><a class="admonition-anchor-link" href="#admonition-fixed-tests-1"></a></p>
</div>
<div>
<p>Test <code>test_require_task</code> should now succeed.</p>
</div>
</div>
<details id="admonition-download-source-code" class="admonition admonish-example">
<summary class="admonition-title">
<p>Download source code</p>
<p><a class="admonition-anchor-link" href="#admonition-download-source-code"></a></p>
</summary>
<div>
<p>You can <a href="../../gen/3_min_sound/4_fix_task_dep/source.zip">download the source files up to this point</a>.</p>
</div>
</details>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../3_min_sound/3_test/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../3_min_sound/5_overlap/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../3_min_sound/3_test/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../3_min_sound/5_overlap/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../.././diff2html-ui-base.min.js"></script>


    </div>
    </body>
</html>
