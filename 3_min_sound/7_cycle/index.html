<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Prevent Cycles - Build your own Programmatic Incremental Build System</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../.././diff2html.min.css">
        <link rel="stylesheet" href="../.././mdbook-admonish.css">

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../0_intro/index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../0_intro/1_setup/index.html"><strong aria-hidden="true">1.1.</strong> Setup</a></li></ol></li><li class="chapter-item expanded "><a href="../../1_programmability/index.html"><strong aria-hidden="true">2.</strong> Programmability</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../1_programmability/1_api/index.html"><strong aria-hidden="true">2.1.</strong> Programmable Build System API</a></li><li class="chapter-item expanded "><a href="../../1_programmability/2_non_incremental/index.html"><strong aria-hidden="true">2.2.</strong> Non-Incremental Context</a></li></ol></li><li class="chapter-item expanded "><a href="../../2_incrementality/index.html"><strong aria-hidden="true">3.</strong> Incrementality</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../2_incrementality/1_require_file/index.html"><strong aria-hidden="true">3.1.</strong> Requiring Files</a></li><li class="chapter-item expanded "><a href="../../2_incrementality/2_stamp/index.html"><strong aria-hidden="true">3.2.</strong> Stamps</a></li><li class="chapter-item expanded "><a href="../../2_incrementality/3_dependency/index.html"><strong aria-hidden="true">3.3.</strong> Dynamic Dependencies</a></li><li class="chapter-item expanded "><a href="../../2_incrementality/4_store/index.html"><strong aria-hidden="true">3.4.</strong> Dependency Graph Store</a></li><li class="chapter-item expanded "><a href="../../2_incrementality/5_context/index.html"><strong aria-hidden="true">3.5.</strong> Incremental Top-Down Context</a></li><li class="chapter-item expanded "><a href="../../2_incrementality/6_example/index.html"><strong aria-hidden="true">3.6.</strong> Incrementality Example</a></li></ol></li><li class="chapter-item expanded "><a href="../../3_min_sound/index.html"><strong aria-hidden="true">4.</strong> Testing Incrementality & Soundness</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../3_min_sound/1_session/index.html"><strong aria-hidden="true">4.1.</strong> Minimality with Sessions</a></li><li class="chapter-item expanded "><a href="../../3_min_sound/2_tracker/index.html"><strong aria-hidden="true">4.2.</strong> Tracking Build Events</a></li><li class="chapter-item expanded "><a href="../../3_min_sound/3_test/index.html"><strong aria-hidden="true">4.3.</strong> Integration Testing</a></li><li class="chapter-item expanded "><a href="../../3_min_sound/4_fix_task_dep/index.html"><strong aria-hidden="true">4.4.</strong> Fix Superfluous Task Dependency</a></li><li class="chapter-item expanded "><a href="../../3_min_sound/5_overlap/index.html"><strong aria-hidden="true">4.5.</strong> Prevent Overlapping File Writes</a></li><li class="chapter-item expanded "><a href="../../3_min_sound/6_hidden_dep/index.html"><strong aria-hidden="true">4.6.</strong> Prevent Hidden Dependencies</a></li><li class="chapter-item expanded "><a href="../../3_min_sound/7_cycle/index.html" class="active"><strong aria-hidden="true">4.7.</strong> Prevent Cycles</a></li></ol></li><li class="chapter-item expanded "><a href="../../4_next/index.html"><strong aria-hidden="true">5.</strong> What's Next?</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
<!-- CHANGE: removed all but light and ayu theme, and renamed ayu to dark -->                          
<!--                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>-->
<!--                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>-->
<!--                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>-->
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Dark</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Build your own Programmatic Incremental Build System</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/Gohla/pie/" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/Gohla/pie/edit/master/tutorial/src/3_min_sound/7_cycle/index.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="prevent-cycles"><a class="header" href="#prevent-cycles">Prevent Cycles</a></h1>
<p>In this section, we will fix the remaining correctness issue with cyclic tasks.</p>
<p>Didn’t we already catch dependency graph cycles in the Incremental Top-Down Context section?
Yes, you remembered right!
However, there is a corner case that we didn’t handle.
The issue is that we add a task dependency to the dependency graph only <em>after the task has finished executing</em>.
We do this because we need the output from executing the task to create the dependency.</p>
<p>But what would happen if we made a task that just requires itself?
Let’s figure that out in this section, in which we will:</p>
<ol>
<li>Add cyclic tasks to the testing tasks.</li>
<li>Create tests to showcase the cyclic task execution problem.</li>
<li>Prevent cycles by <em>reserving</em> a task dependency before executing the task.</li>
</ol>
<h2 id="add-cyclic-testing-tasks"><a class="header" href="#add-cyclic-testing-tasks">Add cyclic testing tasks</a></h2>
<p>We don’t have any testing tasks to easily construct different kinds of cycles yet, so we will add those first.</p>
<p>Modify <code>pie/tests/common/mod.rs</code>:</p>
<div class="diff2html" id="diff2html_0"></div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    let diff = String.raw`--- pie/tests/common/mod.rs
+++ pie/tests/common/mod.rs
@@ -68,6 +68,9 @@
   ToLower(Box<TestTask>),
   ToUpper(Box<TestTask>),
   Sequence(Vec<TestTask>),
+  RequireSelf,
+  RequireA,
+  RequireB,
 }
 impl Task for TestTask {
   type Output = Result<TestOutput, ErrorKind>;
@@ -104,6 +107,9 @@
         }
         Ok(TestOutput::Unit)
       }
+      TestTask::RequireSelf => context.require_task(&TestTask::RequireSelf),
+      TestTask::RequireA => context.require_task(&TestTask::RequireB),
+      TestTask::RequireB => context.require_task(&TestTask::RequireA),
     }
   }
 }
`;
    let target = document.getElementById('diff2html_0');
    let configuration = {
      drawFileList: false,
      fileListToggle: false,
      fileContentToggle: false,

      outputFormat: 'line-by-line',
      matching: 'lines',
    };
    let diff2htmlUi = new Diff2HtmlUI(target, diff, configuration, hljs);
    diff2htmlUi.draw();
  });
</script>
<p>We add the <code>RequireSelf</code> task which directly requires itself.
We also add the <code>RequireA</code> and <code>RequireB</code> tasks which require each other in a cycle.
We want to prevent both of these kinds of cycles.</p>
<h2 id="add-cycle-tests"><a class="header" href="#add-cycle-tests">Add cycle tests</a></h2>
<p>Now add tests that check whether requiring these tasks (correctly) panics due to cycles.</p>
<p>Modify <code>pie/tests/top_down.rs</code>:</p>
<pre><code class="language-rust ">// Cycle tests

#[test]
#[should_panic(expected = &quot;Cyclic task dependency&quot;)]
fn require_self_panics() {
  let mut pie = test_pie();
  pie.require(&amp;RequireSelf).unwrap();
}

#[test]
#[should_panic(expected = &quot;Cyclic task dependency&quot;)]
fn require_cycle_a_panics() {
  let mut pie = test_pie();
  pie.require(&amp;RequireA).unwrap();
}

#[test]
#[should_panic(expected = &quot;Cyclic task dependency&quot;)]
fn require_cycle_b_panics() {
  let mut pie = test_pie();
  pie.require(&amp;RequireB).unwrap();
}</code></pre>
<p>These test are simple: require the task and that’s it.
Which of these tests will correctly result in a cyclic task dependency panic?</p>
<div id="admonition-infinite-recursion" class="admonition admonish-warning">
<div class="admonition-title">
<p>Infinite Recursion</p>
<p><a class="admonition-anchor-link" href="#admonition-infinite-recursion"></a></p>
</div>
<div>
<p>Running these tests will result in infinite recursion, but should quickly cause a stack overflow.
However, be sure to save everything in the event your computer becomes unresponsive.</p>
</div>
</div>
<div id="admonition-expected-test-failure" class="admonition admonish-failure">
<div class="admonition-title">
<p>Expected Test Failure</p>
<p><a class="admonition-anchor-link" href="#admonition-expected-test-failure"></a></p>
</div>
<div>
<p>Tests <code>require_self_panics</code>, <code>require_cycle_a_panics</code>, and <code>require_cycle_b_panics</code> will fail as expected, which we will fix in this section!</p>
</div>
</div>
<p>Run the tests with <code>cargo test</code>, or skip running them (and comment them out) if you don’t want to waste battery life running infinite recursions.
These tests will infinitely recurse and thus fail.</p>
<p>The issue is that we only add a dependency to the dependency graph <em>after the task has executed</em>.
We do this because we need the output from the executing task to create the dependency.
Therefore, no dependencies are ever added to the dependency graph in these tests, because a task never finishes executing!
This in turn causes the cycle detection to never trigger, because there is no cycle in the dependency graph.</p>
<p>To fix this, we need to add task dependencies to the dependency graph <em>before we execute the task</em>.
But we cannot do this, because we need the output of the task to create the task dependency.
Therefore, we need to first <em>reserve</em> a task dependency in the dependency graph, which creates an edge in the dependency graph without any attached data.</p>
<h2 id="reserving-task-dependencies"><a class="header" href="#reserving-task-dependencies">Reserving task dependencies</a></h2>
<p>To support reserved task dependencies, we will first add a <code>ReservedRequireTask</code> variant to <code>Dependency</code>.
Modify <code>pie/src/dependency.rs</code>:</p>
<div class="diff2html" id="diff2html_1"></div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    let diff = String.raw`--- pie/src/dependency.rs
+++ pie/src/dependency.rs
@@ -111,6 +111,7 @@
   RequireFile(FileDependency),
   ProvideFile(FileDependency),
   RequireTask(TaskDependency<T, O>),
+  ReservedRequireTask,
 }
 
 #[derive(Clone, Eq, PartialEq, Debug)]
@@ -124,6 +125,10 @@
   /// - ${"`"}Ok(Some(stamp))${"`"} if the dependency is inconsistent (with ${"`"}stamp${"`"} being the new stamp of the dependency),
   /// - ${"`"}Ok(None)${"`"} if the dependency is consistent,
   /// - ${"`"}Err(e)${"`"} if there was an error checking the dependency for consistency.
+  ///
+  /// # Panics
+  ///
+  /// Panics when this dependency is a [Dependency::ReservedRequireTask] dependency.
   pub fn is_inconsistent<C: MakeConsistent<T>>(&self, context: &mut C) -> Result<Option<Inconsistency<T::Output>>, io::Error> {
     let option = match self {
       Dependency::RequireFile(d) => d.is_inconsistent()?
@@ -132,6 +137,7 @@
         .map(|s| Inconsistency::File(s)),
       Dependency::RequireTask(d) => d.is_inconsistent(context)
         .map(|s| Inconsistency::Task(s)),
+      Dependency::ReservedRequireTask => panic!("BUG: consistency checking reserved task dependency"),
     };
     Ok(option)
   }
`;
    let target = document.getElementById('diff2html_1');
    let configuration = {
      drawFileList: false,
      fileListToggle: false,
      fileContentToggle: false,

      outputFormat: 'line-by-line',
      matching: 'lines',
    };
    let diff2htmlUi = new Diff2HtmlUI(target, diff, configuration, hljs);
    diff2htmlUi.draw();
  });
</script>
<p>The <code>ReservedRequireTask</code> variant has no data, as this variant needs to be creatable before we have the output of the task.</p>
<p>A reserved task dependency cannot be consistency checked, so we panic if this occurs, but this will never occur if our implementation is correct.
A reserved task dependency is added from the current executing task that is being made consistent, and we never check a task that is already consistent this session.
As long as the reserved task dependency is updated to a real <code>RequireTask</code> dependency within this session, we will never check a reserved task dependency.</p>
<div id="admonition-properties-of-the-build-system" class="admonition admonish-note">
<div class="admonition-title">
<p>Properties of the Build System</p>
<p><a class="admonition-anchor-link" href="#admonition-properties-of-the-build-system"></a></p>
</div>
<div>
<p>Again, it is great that we have defined these kind of properties/invariants of the build system, so we can informally reason about whether certain situations occur or not.</p>
</div>
</div>
<p>This change breaks the <code>WritingTracker</code>, which we will update in <code>pie/src/tracker/writing.rs</code>:</p>
<div class="diff2html" id="diff2html_2"></div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    let diff = String.raw`--- pie/src/tracker/writing.rs
+++ pie/src/tracker/writing.rs
@@ -120,6 +120,7 @@
           _ => {}, // Other variants cannot occur.
         }
       }
+      Dependency::ReservedRequireTask => {} // Ignore: reserved task dependencies are never checked.
     }
     self.flush()
   }
`;
    let target = document.getElementById('diff2html_2');
    let configuration = {
      drawFileList: false,
      fileListToggle: false,
      fileContentToggle: false,

      outputFormat: 'line-by-line',
      matching: 'lines',
    };
    let diff2htmlUi = new Diff2HtmlUI(target, diff, configuration, hljs);
    diff2htmlUi.draw();
  });
</script>
<p>Since reserved task dependencies are never checked, we can just ignore them in the <code>check_dependency_end</code> method.</p>
<p>Now we update the <code>Store</code> with a method to reserve a task dependency, and a method to update a reserved task dependency to a real one.
Modify <code>pie/src/store.rs</code>:</p>
<div class="diff2html" id="diff2html_3"></div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    let diff = String.raw`--- pie/src/store.rs
+++ pie/src/store.rs
@@ -217,7 +217,7 @@
       _ => {},
     }
   }
-  /// Adds a task require ${"`"}dependency${"`"} from task ${"`"}src${"`"} to task ${"`"}dst${"`"}.
+  /// Reserves a task require dependency from task ${"`"}src${"`"} to task ${"`"}dst${"`"}.
   ///
   /// # Errors
   ///
@@ -226,13 +226,25 @@
   /// # Panics
   ///
   /// Panics if ${"`"}src${"`"} or ${"`"}dst${"`"} were not found in the dependency graph.
-  pub fn add_task_require_dependency(&mut self, src: &TaskNode, dst: &TaskNode, dependency: TaskDependency<T, T::Output>) -> Result<(), ()> {
-    match self.graph.add_edge(src, dst, Dependency::RequireTask(dependency)) {
+  pub fn reserve_task_require_dependency(&mut self, src: &TaskNode, dst: &TaskNode) -> Result<(), ()> {
+    match self.graph.add_edge(src, dst, Dependency::ReservedRequireTask) {
       Err(pie_graph::Error::NodeMissing) => panic!("BUG: source node {:?} or destination node {:?} was not found in the dependency graph", src, dst),
       Err(pie_graph::Error::CycleDetected) => Err(()),
       _ => Ok(()),
     }
   }
+  /// Updates a reserved task require dependency from task ${"`"}src${"`"} to task ${"`"}dst${"`"}, to ${"`"}dependency${"`"}.
+  ///
+  /// # Panics
+  ///
+  /// Panics if ${"`"}src${"`"} or ${"`"}dst${"`"} were not found in the dependency graph, or if the dependency between ${"`"}src${"`"} and ${"`"}dst${"`"} is
+  /// not a reserved task dependency.
+  pub fn update_task_require_dependency(&mut self, src: &TaskNode, dst: &TaskNode, dependency: TaskDependency<T, T::Output>) {
+    let Some(d @ Dependency::ReservedRequireTask) = self.graph.get_edge_data_mut(src, dst) else {
+      panic!("BUG: no reserved task dependency was found between source node {:?} and destination node {:?}", src, dst)
+    };
+    *d = Dependency::RequireTask(dependency);
+  }
 }
 
 impl<T: Task> Store<T, T::Output> {
`;
    let target = document.getElementById('diff2html_3');
    let configuration = {
      drawFileList: false,
      fileListToggle: false,
      fileContentToggle: false,

      outputFormat: 'side-by-side',
      matching: 'lines',
    };
    let diff2htmlUi = new Diff2HtmlUI(target, diff, configuration, hljs);
    diff2htmlUi.draw();
  });
</script>
<p>We rename <code>add_task_require_dependency</code> to <code>reserve_task_require_dependency</code>, change it to add <code>Dependency::ReservedRequireTask</code> as edge dependency data, and remove the <code>dependency</code> parameter since we don’t need that anymore.
Note that this method still creates the dependency edge, and can still create cycles which need to be handled.
This is good, because this allows us to catch cycles before we start checking and potentially executing a task.
For example, this will catch the self-cycle created by <code>TestTask::RequireSelf</code> because <code>graph.add_edge</code> returns a cycle error on a self-cycle.</p>
<p>We add the <code>update_task_require_dependency</code> method to update a reserved task dependency to a real one.</p>
<p>As per usual, we will update the tests.
Modify <code>pie/src/store.rs</code>:</p>
<div class="diff2html" id="diff2html_4"></div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    let diff = String.raw`--- pie/src/store.rs
+++ pie/src/store.rs
@@ -431,10 +431,16 @@
     assert!(!store.contains_transitive_task_dependency(&node_a, &node_b));
     assert!(!store.contains_transitive_task_dependency(&node_b, &node_a));
 
-    // Add task dependency from task B to task A.
+    // Reserve task dependency from task B to task A.
     let task_dependency_b2a = TaskDependency::new(task_a.clone(), OutputStamper::Equals, output_a.clone());
-    let result = store.add_task_require_dependency(&node_b, &node_a, task_dependency_b2a.clone());
+    let result = store.reserve_task_require_dependency(&node_b, &node_a);
     assert_eq!(result, Ok(()));
+    let deps_of_b: Vec<_> = store.get_dependencies_of_task(&node_b).cloned().collect();
+    assert_eq!(deps_of_b.get(0), Some(&Dependency::ReservedRequireTask));
+    assert_eq!(deps_of_b.get(1), None);
+
+    // Update task dependency from task B to task A.
+    store.update_task_require_dependency(&node_b, &node_a, task_dependency_b2a.clone());
     let deps_of_a: Vec<_> = store.get_dependencies_of_task(&node_a).cloned().collect();
     assert_eq!(deps_of_a.get(0), Some(&Dependency::RequireFile(file_dependency_a2c.clone())));
     assert_eq!(deps_of_a.get(1), None);
@@ -465,9 +471,8 @@
     assert!(!store.contains_transitive_task_dependency(&node_a, &node_b));
     assert!(store.contains_transitive_task_dependency(&node_b, &node_a));
 
-    // Add task dependency from task A to task B, creating a cycle.
-    let task_dependency_a2b = TaskDependency::new(task_a.clone(), OutputStamper::Equals, output_a.clone());
-    let result = store.add_task_require_dependency(&node_a, &node_b, task_dependency_a2b);
+    // Reserve task dependency from task A to task B, creating a cycle.
+    let result = store.reserve_task_require_dependency(&node_a, &node_b);
     assert_eq!(result, Err(())); // Creates a cycle: error
   }
 
@@ -531,14 +536,39 @@
 
   #[test]
   #[should_panic]
-  fn test_add_task_require_dependency_panics() {
+  fn test_reserve_task_require_dependency_panics() {
+    let mut fake_store = Store::default();
+    let output = "Hello".to_string();
+    let task = StringConstant::new(&output);
+    let fake_task_node = fake_store.get_or_create_task_node(&task);
+    let mut store: Store<StringConstant, String> = Store::default();
+    let _ = store.reserve_task_require_dependency(&fake_task_node, &fake_task_node);
+  }
+
+  #[test]
+  #[should_panic]
+  fn test_update_task_require_dependency_panics_node() {
     let mut fake_store = Store::default();
     let output = "Hello".to_string();
     let task = StringConstant::new(&output);
     let fake_task_node = fake_store.get_or_create_task_node(&task);
     let mut store: Store<StringConstant, String> = Store::default();
     let dependency = TaskDependency::new(task, OutputStamper::Equals, output);
-    let _ = store.add_task_require_dependency(&fake_task_node, &fake_task_node, dependency);
+    store.update_task_require_dependency(&fake_task_node, &fake_task_node, dependency);
+  }
+
+  #[test]
+  #[should_panic]
+  fn test_update_task_require_dependency_panics_dependency() {
+    let mut store: Store<StringConstant, String> = Store::default();
+    let output_a = "Hello".to_string();
+    let task_a = StringConstant::new(&output_a);
+    let task_node_a = store.get_or_create_task_node(&task_a);
+    let output_b = "World".to_string();
+    let task_b = StringConstant::new(&output_b);
+    let task_node_b = store.get_or_create_task_node(&task_b);
+    let dependency = TaskDependency::new(task_b, OutputStamper::Equals, output_b);
+    store.update_task_require_dependency(&task_node_a, &task_node_b, dependency);
   }
 
 
`;
    let target = document.getElementById('diff2html_4');
    let configuration = {
      drawFileList: false,
      fileListToggle: false,
      fileContentToggle: false,

      outputFormat: 'side-by-side',
      matching: 'lines',
    };
    let diff2htmlUi = new Diff2HtmlUI(target, diff, configuration, hljs);
    diff2htmlUi.draw();
  });
</script>
<p>We update <code>test_dependencies</code> to reserve and update task dependencies, and rename <code>test_add_task_require_dependency_panics</code>.
We add 2 tests for <code>update_task_require_dependency</code>.</p>
<p>The store now handles reserved task dependencies.
Now we need to use them in <code>TopDownContext</code>.
Task dependencies are made in <code>require_file_with_stamper</code>, so we just need to update that method.</p>
<p>Modify <code>pie/src/context/top_down.rs</code>:</p>
<div class="diff2html" id="diff2html_5"></div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    let diff = String.raw`--- pie/src/context/top_down.rs
+++ pie/src/context/top_down.rs
@@ -79,17 +79,22 @@
     self.session.tracker.require_task_start(task, &stamper);
 
     let node = self.session.store.get_or_create_task_node(task);
+    if let Some(current_executing_task_node) = &self.session.current_executing_task {
+      // First reserve a task require dependency to catch cycles before (potentially) executing the task, and to have
+      // the dependency edge in the graph for catching future cycles.
+      if self.session.store.reserve_task_require_dependency(current_executing_task_node, &node).is_err() {
+        let current_executing_task = self.session.store.get_task(current_executing_task_node);
+        panic!("Cyclic task dependency; current executing task '{:?}' is requiring task '{:?}' which was already required", current_executing_task, task);
+      }
+    }
     let (output, was_executed) = self.make_task_consistent(task, node);
 
     let dependency = TaskDependency::new(task.clone(), stamper, output.clone());
     self.session.tracker.require_task_end(&dependency, &output, was_executed);
 
-    // Create task require dependency if a task is currently executing (i.e., we are not requiring the initial task).
     if let Some(current_executing_task_node) = &self.session.current_executing_task {
-      if self.session.store.add_task_require_dependency(current_executing_task_node, &node, dependency).is_err() {
-        let current_executing_task = self.session.store.get_task(current_executing_task_node);
-        panic!("Cyclic task dependency; current executing task '{:?}' is requiring task '{:?}' which was already required", current_executing_task, task);
-      }
+      // Update the reserved task require dependency to a real task require dependency.
+      self.session.store.update_task_require_dependency(current_executing_task_node, &node, dependency)
     }
 
     output
`;
    let target = document.getElementById('diff2html_5');
    let configuration = {
      drawFileList: false,
      fileListToggle: false,
      fileContentToggle: false,

      outputFormat: 'side-by-side',
      matching: 'lines',
    };
    let diff2htmlUi = new Diff2HtmlUI(target, diff, configuration, hljs);
    diff2htmlUi.draw();
  });
</script>
<p>Before we call <code>make_task_consistent</code> and potentially execute a task, we first reserve the task dependency (if a task is currently executing).
Since <code>reserve_task_require_dependency</code> now can make cycles, we move the cycle check to the start.
As mentioned before, this will catch self cycles.</p>
<p>Additionally, this will add a dependency edge to the graph that is needed to catch future cycles, such as the cycle between <code>TestTask::RequireA</code> and <code>TestTask::RequireB</code>.
For example, <code>TestTask::RequireA</code> executes and requires <code>TestTask::RequireB</code>, thus we reserve an edge from A to B.
Then, we require and execute B, which requires A, thus we reserve an edge from B to A, and the cycle is detected!
If the edge from A to B was not in the graph before executing B, we would not catch this cycle.</p>
<p>After the call to <code>make_task_consistent</code> we have the consistent output of the task, and we update the reserved dependency to a real one with <code>update_task_require_dependency</code>.</p>
<p>This will correctly detect all cyclic tasks.
Confirm your changes work and all tests now succeed with <code>cargo test</code>.</p>
<div id="admonition-fixed-tests" class="admonition admonish-success">
<div class="admonition-title">
<p>Fixed Tests</p>
<p><a class="admonition-anchor-link" href="#admonition-fixed-tests"></a></p>
</div>
<div>
<p>Tests <code>require_self_panics</code>, <code>require_cycle_a_panics</code>, and <code>require_cycle_b_panics</code> should now succeed.</p>
</div>
</div>
<p>We don’t need to write additional tests, as these 3 tests capture the kind of cycles we wanted to fix.
Additional positive tests are not really needed, as the other tests cover the fact that cycles are only detected when there actually is one.</p>
<p>This is the last correctness issue that needed to be solved.
Our programmatic incremental build system is now truly incremental (minimal) and correct (sound)!
There are of course certain caveats, such as non-canonical paths and symbolic links which need to be solved for additional correctness.
We will not do that in this tutorial, but feel free to solve those issues (and write tests for them!).</p>
<details id="admonition-download-source-code" class="admonition admonish-example">
<summary class="admonition-title">
<p>Download source code</p>
<p><a class="admonition-anchor-link" href="#admonition-download-source-code"></a></p>
</summary>
<div>
<p>You can <a href="../../gen/3_min_sound/7_cycle/source.zip">download the source files up to this point</a>.</p>
</div>
</details>
<p>This is currently the end of the guided programming tutorial.
In the next chapter, we discuss future work, the PIE library implementations and publications about PIE, and other related work.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../3_min_sound/6_hidden_dep/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../4_next/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../3_min_sound/6_hidden_dep/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../4_next/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../.././diff2html-ui-base.min.js"></script>


    </div>
    </body>
</html>
