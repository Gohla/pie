<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Stamps - Build your own Programmatic Incremental Build System</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../.././diff2html.min.css">
        <link rel="stylesheet" href="../.././mdbook-admonish.css">

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../0_intro/index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../0_intro/1_setup/index.html"><strong aria-hidden="true">1.1.</strong> Setup</a></li></ol></li><li class="chapter-item expanded "><a href="../../1_programmability/index.html"><strong aria-hidden="true">2.</strong> Programmability</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../1_programmability/1_api/index.html"><strong aria-hidden="true">2.1.</strong> Programmable Build System API</a></li><li class="chapter-item expanded "><a href="../../1_programmability/2_non_incremental/index.html"><strong aria-hidden="true">2.2.</strong> Non-Incremental Context</a></li></ol></li><li class="chapter-item expanded "><a href="../../2_incrementality/index.html"><strong aria-hidden="true">3.</strong> Incrementality</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../2_incrementality/1_require_file/index.html"><strong aria-hidden="true">3.1.</strong> Requiring Files</a></li><li class="chapter-item expanded "><a href="../../2_incrementality/2_stamp/index.html" class="active"><strong aria-hidden="true">3.2.</strong> Stamps</a></li><li class="chapter-item expanded "><a href="../../2_incrementality/3_dependency/index.html"><strong aria-hidden="true">3.3.</strong> Dynamic Dependencies</a></li><li class="chapter-item expanded "><a href="../../2_incrementality/4_store/index.html"><strong aria-hidden="true">3.4.</strong> Dependency Graph Store</a></li><li class="chapter-item expanded "><a href="../../2_incrementality/5_context/index.html"><strong aria-hidden="true">3.5.</strong> Incremental Top-Down Context</a></li><li class="chapter-item expanded "><a href="../../2_incrementality/6_example/index.html"><strong aria-hidden="true">3.6.</strong> Incrementality Example</a></li></ol></li><li class="chapter-item expanded "><a href="../../3_min_sound/index.html"><strong aria-hidden="true">4.</strong> Testing Incrementality & Soundness</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../3_min_sound/1_session/index.html"><strong aria-hidden="true">4.1.</strong> Minimality with Sessions</a></li><li class="chapter-item expanded "><a href="../../3_min_sound/2_tracker/index.html"><strong aria-hidden="true">4.2.</strong> Tracking Build Events</a></li><li class="chapter-item expanded "><a href="../../3_min_sound/3_test/index.html"><strong aria-hidden="true">4.3.</strong> Integration Testing</a></li><li class="chapter-item expanded "><a href="../../3_min_sound/4_fix_task_dep/index.html"><strong aria-hidden="true">4.4.</strong> Fix Superfluous Task Dependency</a></li><li class="chapter-item expanded "><a href="../../3_min_sound/5_overlap/index.html"><strong aria-hidden="true">4.5.</strong> Prevent Overlapping File Writes</a></li><li class="chapter-item expanded "><a href="../../3_min_sound/6_hidden_dep/index.html"><strong aria-hidden="true">4.6.</strong> Prevent Hidden Dependencies</a></li><li class="chapter-item expanded "><a href="../../3_min_sound/7_cycle/index.html"><strong aria-hidden="true">4.7.</strong> Prevent Cycles</a></li></ol></li><li class="chapter-item expanded "><a href="../../4_next/index.html"><strong aria-hidden="true">5.</strong> What's Next?</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
<!-- CHANGE: removed all but light and ayu theme, and renamed ayu to dark -->                          
<!--                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>-->
<!--                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>-->
<!--                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>-->
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Dark</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Build your own Programmatic Incremental Build System</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/Gohla/pie/" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/Gohla/pie/edit/master/tutorial/src/2_incrementality/2_stamp/index.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="stamps"><a class="header" href="#stamps">Stamps</a></h1>
<p>To check whether we need to execute a task, we need to check the dependencies of that task to see if any of them are inconsistent.
To make this consistency checking configurable, we will use stamps.
A dependency is inconsistent if after stamping, the new stamp is different from the old stamp.
Therefore, we will implement a <code>FileStamper</code> that stamps files and produces a <code>FileStamp</code>, and an <code>OutputStamper</code> that stamps task outputs and produces an <code>OutputStamp</code>.</p>
<p>Add the <code>stamp</code> module to <code>pie/src/lib.rs</code>:</p>
<div class="diff2html" id="diff2html_0"></div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    let diff = String.raw`--- pie/src/lib.rs
+++ pie/src/lib.rs
@@ -4,6 +4,7 @@
 use std::io;
 use std::path::Path;
 
+pub mod stamp;
 pub mod context;
 mod fs;
 
`;
    let target = document.getElementById('diff2html_0');
    let configuration = {
      drawFileList: false,
      fileListToggle: false,
      fileContentToggle: false,

      outputFormat: 'line-by-line',
      matching: 'lines',
    };
    let diff2htmlUi = new Diff2HtmlUI(target, diff, configuration, hljs);
    diff2htmlUi.draw();
  });
</script>
<p>This module is public as users of the library will construct stampers.</p>
<h2 id="file-stamps"><a class="header" href="#file-stamps">File stamps</a></h2>
<p>Create the <code>pie/src/stamp.rs</code> file and add:</p>
<pre><code class="language-rust ">use std::fmt::Debug;
use std::io;
use std::path::Path;
use std::time::SystemTime;

use crate::fs::metadata;

#[derive(Copy, Clone, Ord, PartialOrd, Eq, PartialEq, Hash, Debug)]
pub enum FileStamper {
  Exists,
  Modified,
}

#[derive(Copy, Clone, Ord, PartialOrd, Eq, PartialEq, Hash, Debug)]
pub enum FileStamp {
  Exists(bool),
  Modified(Option&lt;SystemTime&gt;),
}

impl FileStamper {
  pub fn stamp(&amp;self, path: impl AsRef&lt;Path&gt;) -&gt; Result&lt;FileStamp, io::Error&gt; {
    match self {
      FileStamper::Exists =&gt; {
        Ok(FileStamp::Exists(path.as_ref().try_exists()?))
      }
      FileStamper::Modified =&gt; {
        let Some(metadata) = metadata(path)? else {
          return Ok(FileStamp::Modified(None));
        };
        Ok(FileStamp::Modified(Some(metadata.modified()?)))
      }
    }
  }
}</code></pre>
<p>We’re implementing <code>FileStamper</code> as an enum for simplicity.</p>
<p>A <code>FileStamper</code> has a single method <code>stamp</code> which takes something that can be dereferenced to a path, and produces a <code>FileStamp</code> or an error if creating the stamp failed.
For now, we implement only two kinds of file stampers: <code>Exists</code> and <code>Modified</code>.
The <code>Exists</code> stamper just returns a boolean indicating whether a file exists.
It can be used to create a file dependency where a task behaves differently based on whether a file exists or not.
The <code>Modified</code> stamper returns the last modification date if the file exists, or <code>None</code> if the file does not exist.</p>
<p>We derive <code>Eq</code> for stamps so that we can compare them.
Equal (same) stamps indicate a consistent dependency, unequal (different) indicates inconsistent.
We also derive <code>Eq</code> for stampers, because the stamper of a dependency could change, making the dependency inconsistent.</p>
<h2 id="task-output-stamps"><a class="header" href="#task-output-stamps">Task output stamps</a></h2>
<p>We implement task output stampers in a similar way.
Add to <code>pie/src/stamp.rs</code>:</p>
<pre><code class="language-rust ">#[derive(Copy, Clone, Ord, PartialOrd, Eq, PartialEq, Hash, Debug)]
pub enum OutputStamper {
  Inconsequential,
  Equals,
}

#[derive(Clone, Eq, PartialEq, Debug)]
pub enum OutputStamp&lt;O&gt; {
  Inconsequential,
  Equals(O),
}

impl OutputStamper {
  pub fn stamp&lt;O&gt;(&amp;self, output: O) -&gt; OutputStamp&lt;O&gt; {
    match self {
      OutputStamper::Inconsequential =&gt; OutputStamp::Inconsequential,
      OutputStamper::Equals =&gt; OutputStamp::Equals(output),
    }
  }
}</code></pre>
<p>The <code>Inconsequential</code> stamper simply ignores the output and always returns the same stamp (thus is always equal).
It can be used to create a task dependency where we are interested in some side effect of a task, but don’t care about its output.
The <code>Equals</code> stamper simply wraps the output of a task, so the stamp is equal when the output is equal.</p>
<p>Output stamps are generic over the task output type <code>O</code>.</p>
<details id="admonition-trait-bounds-and-derive-macros" class="admonition admonish-tip">
<summary class="admonition-title">
<p>Trait Bounds and Derive Macros</p>
<p><a class="admonition-anchor-link" href="#admonition-trait-bounds-and-derive-macros"></a></p>
</summary>
<div>
<p>Because <code>O</code> is used in the enum, the <code>derive</code> attributes on <code>OutputStamp</code> create bounds over <code>O</code>.
Thus, <code>OutputStamp</code> is only <code>Clone</code> when <code>O</code> is <code>Clone</code>, <code>OutputStamp</code> is only <code>Eq</code> when <code>O</code> is <code>Eq</code>, and so forth.
Because we declared <code>Task::Output</code> with bound <code>Clone + Eq + Debug</code>, we can be sure that <code>OutputStamp</code> is always <code>Clone</code>, <code>Eq</code>, and <code>Debug</code>.</p>
</div>
</details>
<details id="admonition-user-defined-stamps" class="admonition admonish-question">
<summary class="admonition-title">
<p>User-Defined Stamps?</p>
<p><a class="admonition-anchor-link" href="#admonition-user-defined-stamps"></a></p>
</summary>
<div>
<p><code>FileStamper</code> and <code>OutputStamper</code> could also be a trait which would allow users of the library to implement their own stampers.
For simplicity, we do not explore that option in this tutorial.
In the actual PIE library, stampers (called checkers) can be implemented by users of the library!</p>
</div>
</details>
<h2 id="tests"><a class="header" href="#tests">Tests</a></h2>
<p>Finally, we write some tests.
Add to <code>pie/src/stamp.rs</code>:</p>
<pre><code class="language-rust ">#[cfg(test)]
mod test {
  use std::fs::{remove_file, write};
  use std::io;

  use dev_shared::create_temp_file;

  use super::*;

  #[test]
  fn test_exists_file_stamper() -&gt; Result&lt;(), io::Error&gt; {
    let stamper = FileStamper::Exists;
    let temp_file = create_temp_file()?;
    let stamp = stamper.stamp(&amp;temp_file)?;
    assert_eq!(stamp, stamper.stamp(&amp;temp_file)?);

    remove_file(&amp;temp_file)?;
    assert_ne!(stamp, stamper.stamp(&amp;temp_file)?);

    Ok(())
  }

  #[test]
  fn test_modified_file_stamper() -&gt; Result&lt;(), io::Error&gt; {
    let stamper = FileStamper::Modified;
    let temp_file = create_temp_file()?;
    let stamp = stamper.stamp(&amp;temp_file)?;
    assert_eq!(stamp, stamper.stamp(&amp;temp_file)?);

    write(&amp;temp_file, format!(&quot;{:?}&quot;, stamp))?;
    let new_stamp = stamper.stamp(&amp;temp_file)?;
    assert_ne!(stamp, new_stamp);
    let stamp = new_stamp;

    remove_file(&amp;temp_file)?;
    assert_ne!(stamp, stamper.stamp(&amp;temp_file)?);

    Ok(())
  }

  #[test]
  fn test_inconsequential_output_stamper() {
    let stamper = OutputStamper::Inconsequential;
    let stamp = stamper.stamp(&amp;1);
    assert_eq!(stamp, stamper.stamp(&amp;1));
    assert_eq!(stamp, stamper.stamp(&amp;2));
  }

  #[test]
  fn test_equals_output_stamper() {
    let stamper = OutputStamper::Equals;
    let stamp = stamper.stamp(&amp;1);
    assert_eq!(stamp, stamper.stamp(&amp;1));
    assert_ne!(stamp, stamper.stamp(&amp;2));
  }
}</code></pre>
<p>We test file stamps by creating a stamp, changing the file, creating a new stamp, and then compare the stamps.
We test task output stamps by just passing a different output value to the <code>stamp</code> function, and then compare the stamps.</p>
<p>Run <code>cargo test</code> to test the stamp implementation.
However, a test could fail on some operating systems.
Do continue to the next subsection if this happens.</p>
<div id="admonition-likely-test-failure" class="admonition admonish-warning">
<div class="admonition-title">
<p>Likely Test Failure</p>
<p><a class="admonition-anchor-link" href="#admonition-likely-test-failure"></a></p>
</div>
<div>
<p>Test <code>test_modified_file_stamper</code> will likely fail. Do continue to the next subsection, because we’re going to fix it!</p>
</div>
</div>
<h2 id="testing-with-file-modified-time-correctly"><a class="header" href="#testing-with-file-modified-time-correctly">Testing with file modified time, correctly</a></h2>
<p>Unfortunately, these tests may fail on some operating systems (Linux and Windows in my testing), due to an imprecise file last modified timer.
What can happen is that we write to a file, making the OS update its modified time to <code>1000</code> (as an example, not a real timestamp), then very quickly write to the file again, making the OS update its modified time to <code>1000</code> again.
Then, our test will fail because the stamp didn’t change even though we expect it to change.</p>
<p>This can happen with an imprecise timer that only increases once every millisecond (again, an example, not a real number) when we perform writes in between that millisecond.
Even worse, our test can be flaky, sometimes succeeding if we write in between those milliseconds, sometimes failing if we write within a millisecond.</p>
<p>To solve this, add a function to the filesystem testing utility crate.
Change <code>dev_shared/src/lib.rs</code>:</p>
<div class="diff2html" id="diff2html_1"></div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    let diff = String.raw`--- dev_shared/src/lib.rs
+++ dev_shared/src/lib.rs
@@ -1,4 +1,7 @@
+use std::fs::{metadata, write};
 use std::io;
+use std::path::Path;
+use std::time::SystemTime;
 
 use tempfile::{NamedTempFile, TempDir};
 
@@ -7,3 +10,29 @@
 
 /// Creates a new temporary directory that gets cleaned up when dropped.
 pub fn create_temp_dir() -> Result<TempDir, io::Error> { TempDir::new() }
+
+/// Keeps writing ${"`"}contents${"`"} to file at ${"`"}path${"`"} until its last modified time changes, then returns the modified time.
+/// This is required because some OSs have imprecise modified timers, where the file modified time does not change when
+/// writing in quick succession.
+///
+/// # Errors
+///
+/// Returns an error when any file operation fails.
+pub fn write_until_modified(path: impl AsRef<Path>, contents: impl AsRef<[u8]>) -> Result<SystemTime, io::Error> {
+  let path = path.as_ref();
+  let contents = contents.as_ref();
+  fn get_modified(path: impl AsRef<Path>) -> Result<SystemTime, io::Error> {
+    let modified = match metadata(path) {
+      Err(e) if e.kind() == io::ErrorKind::NotFound => SystemTime::UNIX_EPOCH,
+      Err(e) => Err(e)?,
+      Ok(m) => m.modified()?
+    };
+    Ok(modified)
+  }
+  let modified = get_modified(path)?;
+  loop {
+    write(path, contents)?;
+    if modified != get_modified(path)? { break; }
+  }
+  Ok(modified)
+}
`;
    let target = document.getElementById('diff2html_1');
    let configuration = {
      drawFileList: false,
      fileListToggle: false,
      fileContentToggle: false,

      outputFormat: 'line-by-line',
      matching: 'lines',
    };
    let diff2htmlUi = new Diff2HtmlUI(target, diff, configuration, hljs);
    diff2htmlUi.draw();
  });
</script>
<p>The <code>write_until_modified</code> function writes to the file, but ensures its modified time will change.
Now change the tests in <code>pie/src/stamp.rs</code> to use this function:</p>
<div class="diff2html" id="diff2html_2"></div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    let diff = String.raw`--- pie/src/stamp.rs
+++ pie/src/stamp.rs
@@ -2,10 +2,10 @@
 
 #[cfg(test)]
 mod test {
-  use std::fs::{remove_file, write};
+  use std::fs::remove_file;
   use std::io;
 
-  use dev_shared::create_temp_file;
+  use dev_shared::{create_temp_file, write_until_modified};
 
   use super::*;
 
@@ -29,7 +29,9 @@
     let stamp = stamper.stamp(&temp_file)?;
     assert_eq!(stamp, stamper.stamp(&temp_file)?);
 
-    write(&temp_file, format!("{:?}", stamp))?;
+    // Write until file modified time changes. Required on some OSs due to imprecise modified timer causing the modified
+    // stamp to be the same after fast consecutive writes.
+    write_until_modified(&temp_file, format!("{:?}", stamp))?;
     let new_stamp = stamper.stamp(&temp_file)?;
     assert_ne!(stamp, new_stamp);
     let stamp = new_stamp;
`;
    let target = document.getElementById('diff2html_2');
    let configuration = {
      drawFileList: false,
      fileListToggle: false,
      fileContentToggle: false,

      outputFormat: 'side-by-side',
      matching: 'lines',
    };
    let diff2htmlUi = new Diff2HtmlUI(target, diff, configuration, hljs);
    diff2htmlUi.draw();
  });
</script>
<p>Now we use <code>write_until_modified</code> to write to the file, ensuring its modified time will change, ensuring the stamp will change when it should.
Run <code>cargo test</code> to confirm the stamp implementation, which should succeed now.</p>
<div id="admonition-fixed-tests" class="admonition admonish-success">
<div class="admonition-title">
<p>Fixed Tests</p>
<p><a class="admonition-anchor-link" href="#admonition-fixed-tests"></a></p>
</div>
<div>
<p>Test <code>test_modified_file_stamper</code> should now succeed.</p>
</div>
</div>
<h2 id="stamps-in-context"><a class="header" href="#stamps-in-context">Stamps in Context</a></h2>
<p>We now have a module dedicated to stamps.
However, stampers are constructed by users of the library that author tasks, and they need to pass in these stampers when creating dependencies.
Therefore, we need to update the <code>Context</code> trait to allow passing in these stampers.</p>
<p>Change <code>Context</code> in <code>pie/src/lib.rs</code>:</p>
<div class="diff2html" id="diff2html_3"></div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    let diff = String.raw`--- pie/src/lib.rs
+++ pie/src/lib.rs
@@ -4,6 +4,8 @@
 use std::io;
 use std::path::Path;
 
+use stamp::{FileStamper, OutputStamper};
+
 pub mod stamp;
 pub mod context;
 mod fs;
@@ -19,12 +21,25 @@
 /// Programmatic incremental build context, enabling tasks to create dynamic dependencies that context implementations
 /// use for incremental execution.
 pub trait Context<T: Task> {
-  /// Requires file at given ${"`"}path${"`"}, recording a dependency to it. Call this method *just before reading from the file*,
-  /// so that the dependency corresponds to the data that you are reading. Returns:
+  /// Requires file at given ${"`"}path${"`"}, recording a dependency to it (using the default require file stamper). Call this
+  /// method *just before reading from the file*, so that the dependency corresponds to the data that you are reading.
+  /// Returns:
   /// - ${"`"}Ok(Some(file))${"`"} if a file exists at given ${"`"}path${"`"},
   /// - ${"`"}Ok(None)${"`"} if no file exists at given ${"`"}path${"`"} (but a directory could exist at given ${"`"}path${"`"}),
-  /// - ${"`"}Err(e)${"`"} if there was an error getting the metadata for given ${"`"}path${"`"}, or if there was an error opening the file.
-  fn require_file<P: AsRef<Path>>(&mut self, path: P) -> Result<Option<File>, io::Error>;
+  /// - ${"`"}Err(e)${"`"} if there was an error getting the metadata for given ${"`"}path${"`"}, if there was an error opening the file, or
+  ///   if there was an error stamping the file.
+  fn require_file<P: AsRef<Path>>(&mut self, path: P) -> Result<Option<File>, io::Error> {
+    self.require_file_with_stamper(path, self.default_require_file_stamper())
+  }
+  /// Requires file at given ${"`"}path${"`"}, recording a dependency to it (using given ${"`"}stamper${"`"}). Call this method
+  /// *just before reading from the file*, so that the dependency corresponds to the data that you are reading. Returns:
+  /// - ${"`"}Ok(Some(file))${"`"} if a file exists at given ${"`"}path${"`"},
+  /// - ${"`"}Ok(None)${"`"} if no file exists at given ${"`"}path${"`"} (but a directory could exist at given ${"`"}path${"`"}),
+  /// - ${"`"}Err(e)${"`"} if there was an error getting the metadata for given ${"`"}path${"`"}, if there was an error opening the file, or
+  ///   if there was an error stamping the file.
+  fn require_file_with_stamper<P: AsRef<Path>>(&mut self, path: P, stamper: FileStamper) -> Result<Option<File>, io::Error>;
+  /// Returns the default require file stamper.
+  fn default_require_file_stamper(&self) -> FileStamper { FileStamper::Modified }
 
   /// Requires given ${"`"}task${"`"}, recording a dependency and selectively executing it. Returns its up-to-date output.
   fn require_task(&mut self, task: &T) -> T::Output;
`;
    let target = document.getElementById('diff2html_3');
    let configuration = {
      drawFileList: false,
      fileListToggle: false,
      fileContentToggle: false,

      outputFormat: 'side-by-side',
      matching: 'lines',
    };
    let diff2htmlUi = new Diff2HtmlUI(target, diff, configuration, hljs);
    diff2htmlUi.draw();
  });
</script>
<p>We add the <code>require_file_with_stamper</code> method which allow passing in a stamper.
We add a default implementation for <code>require_file</code> that passes in a default stamper.
The default is provided by <code>default_require_file_stamper</code> which can be overridden by context implementations.</p>
<p>Now apply the same to tasks, changing <code>Context</code> again in <code>pie/src/lib.rs</code>:</p>
<div class="diff2html" id="diff2html_4"></div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    let diff = String.raw`--- pie/src/lib.rs
+++ pie/src/lib.rs
@@ -41,6 +41,14 @@
   /// Returns the default require file stamper.
   fn default_require_file_stamper(&self) -> FileStamper { FileStamper::Modified }
 
-  /// Requires given ${"`"}task${"`"}, recording a dependency and selectively executing it. Returns its up-to-date output.
-  fn require_task(&mut self, task: &T) -> T::Output;
+  /// Requires given ${"`"}task${"`"}, recording a dependency (using the default output stamper) and selectively executing it.
+  /// Returns its up-to-date output.
+  fn require_task(&mut self, task: &T) -> T::Output {
+    self.require_task_with_stamper(task, self.default_output_stamper())
+  }
+  /// Requires given ${"`"}task${"`"}, recording a dependency (using given ${"`"}stamper${"`"}) and selectively executing it. Returns its
+  /// up-to-date output.
+  fn require_task_with_stamper(&mut self, task: &T, stamper: OutputStamper) -> T::Output;
+  /// Returns the default output stamper.
+  fn default_output_stamper(&self) -> OutputStamper { OutputStamper::Equals }
 }
`;
    let target = document.getElementById('diff2html_4');
    let configuration = {
      drawFileList: false,
      fileListToggle: false,
      fileContentToggle: false,

      outputFormat: 'side-by-side',
      matching: 'lines',
    };
    let diff2htmlUi = new Diff2HtmlUI(target, diff, configuration, hljs);
    diff2htmlUi.draw();
  });
</script>
<p>Update <code>NonIncrementalContext</code> in <code>src/context/non_incremental.rs</code> to implement the new methods:</p>
<div class="diff2html" id="diff2html_5"></div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    let diff = String.raw`--- pie/src/context/non_incremental.rs
+++ pie/src/context/non_incremental.rs
@@ -4,15 +4,16 @@
 
 use crate::{Context, Task};
 use crate::fs::open_if_file;
+use crate::stamp::{FileStamper, OutputStamper};
 
 pub struct NonIncrementalContext;
 
 impl<T: Task> Context<T> for NonIncrementalContext {
-  fn require_file<P: AsRef<Path>>(&mut self, path: P) -> Result<Option<File>, io::Error> {
+  fn require_file_with_stamper<P: AsRef<Path>>(&mut self, path: P, _stamper: FileStamper) -> Result<Option<File>, io::Error> {
     open_if_file(&path)
   }
 
-  fn require_task(&mut self, task: &T) -> T::Output {
+  fn require_task_with_stamper(&mut self, task: &T, _stamper: OutputStamper) -> T::Output {
     task.execute(self)
   }
 }
`;
    let target = document.getElementById('diff2html_5');
    let configuration = {
      drawFileList: false,
      fileListToggle: false,
      fileContentToggle: false,

      outputFormat: 'side-by-side',
      matching: 'lines',
    };
    let diff2htmlUi = new Diff2HtmlUI(target, diff, configuration, hljs);
    diff2htmlUi.draw();
  });
</script>
<p>We just ignore the stampers in <code>NonIncrementalContext</code>, as they are only needed for incrementality.</p>
<p>Run <code>cargo test</code> to confirm everything still works.</p>
<details id="admonition-download-source-code" class="admonition admonish-example">
<summary class="admonition-title">
<p>Download source code</p>
<p><a class="admonition-anchor-link" href="#admonition-download-source-code"></a></p>
</summary>
<div>
<p>You can <a href="../../gen/2_incrementality/2_stamp/source.zip">download the source files up to this point</a>.</p>
</div>
</details>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../2_incrementality/1_require_file/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../2_incrementality/3_dependency/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../2_incrementality/1_require_file/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../2_incrementality/3_dependency/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../.././diff2html-ui-base.min.js"></script>


    </div>
    </body>
</html>
